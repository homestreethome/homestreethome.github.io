/**
 * audiowalk
 * @version v0.1.0 - 2014-08-20
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var app=angular.module("lennart.Audiowalk",["ngAnimate","ngRoute","LocalStorageModule","ngTouch","ngSanitize","duScroll","leaflet-directive"]),debug=!1;app.constant("version","v0.1.0").config(["$locationProvider","$routeProvider","$logProvider","$provide",function(e,n,t,i){i.value("debugMode",debug),t.debugEnabled(debug),n.when("/",{templateUrl:"views/start.html"}).when("/credits",{templateUrl:"views/credits.html"}).when("/:slide?",{templateUrl:"views/slide.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$log","localStorageService","$window","ApplicationCache",function(e,n,t,i,a,o){e.online=navigator.onLine,o.init(),a.addEventListener("offline",function(){e.$apply(function(){e.online=!1})},!1),a.addEventListener("online",function(){e.$apply(function(){e.online=!0})},!1)}]),app.controller("MainCtrl",["$scope","$location","version","$log","$window","Places","$routeParams","$rootScope","localStorageService","Audio","Geolocation",function(e,n,t,i,a,o,r,c,d,l,s){e.updateCurrentSlide=function(n){i.debug("updating current slide",n),e.currentSlide=o.idToSlideIndex(n),e.slide=o.slides[e.currentSlide],e.$index=e.currentSlide,e.nextSlideId=o.indexToSlideId(e.currentSlide+1),e.nextSlide=o.slides[e.currentSlide+1],e.prevSlideId=o.indexToSlideId(e.currentSlide-1),c.currentSlideId=e.slide.id,i.debug("[main] slide change",{current:e.slide.id,next:e.nextSlideId,prev:e.prevSlideId})},c.$on("$routeChangeSuccess",function(t,a){"/"===n.path()?i.info("[main] start me up"):(e.updateCurrentSlide(a.params.slide),o.slides.length-1===e.currentSlide?d.set("finished","yes"):i.info("[main] yet another slide:",e.currentSlideId))}),c.$on("$routeChangeStart",function(){s.unwatch()}),e.changeSlide=function(e){n.path(e).replace(),c.$apply()},e.$watch("online",function(e){e?a.ga("send","event","system","change","online"):a.ga("send","event","system","change","offline")})}]),app.controller("StartCtrl",["$scope","$timeout","debugMode","ApplicationCache","$location","version","$log","$window","Places","$routeParams","$rootScope","localStorageService","$document","$element","Audio",function(e,n,t,i,a,o,r,c,d,l,s,u,p,g,h){e.$path=a.path.bind(a),e.version=o,e.appReady=function(n,i){r.info("[app] ready because:",i),t?p.find("body").click(function(){e.loading=!1,e.loaded=!0,e.$apply()}):(e.loading=!1,e.loaded=!0)},e.appLoading=function(n,t){e.loading=!0,e.cachedPercentage=t.percentage,e.scrollingIntro||(r.info("[app] scrolling intro now"),e.scrollingIntro=!0,e.scrollIntro())},e.$on("app:ready",e.appReady),e.trackStartClick=function(){c.ga("send","event","button","click","start button"),r.info("Tracking click to start App")},s.$on("cache:ready",e.appReady),s.$on("cache:loading",e.appLoading),e.firstSlide=d.slides[0].id,e.credits=!1,e.loading=!1,e.loaded=!1,e.toggleCredits=function(){e.credits=e.credits===!1?!0:!1,e.credits===!0&&n(function(){p.scrollToElement(g.find("#credits-block"),c.screen.availHeight,5e4,function(e){return.5>e?2*e*e:-1+(4-2*e)*e}).then(function(){r.debug("no more scrolling credits")})})},h.set("credits","/audio/way/n.mp3"),h.pauseAll(),s.currentSound&&s.currentSound.stop(),e.scrollIntro=function(){n(function(){var e=g.find("#loading-bar-block");e.length&&p.scrollToElement(e,c.screen.availHeight-100,25e3,function(e){return.5>e?2*e*e:-1+(4-2*e)*e}).then(function(){r.info("intro scrolling finished")})})},"yes"==u.get("finished")?(u.set("finished","no"),r.info("[start] finished",u.get("finished")),h.play("credits"),n(function(){e.toggleCredits()},100),e.$emit("app:ready")):i.isLoading()?r.info("[app] caching resources"):(r.info("[app] go!"),e.$emit("app:ready","resume"))}]),app.controller("PlacesCtrl",["debugMode","$rootScope","$scope","$sce","$routeParams","Places","$log","$window","$element","$location","$timeout","Geolocation","$document","Audio",function(e,n,t,i,a,o,r,c,d,l,s,u,p,g){if(t.debugMode=e,t.$on("map:destination:reached",function(){r.info("[places] destination reached, vibrating, awareness, now!"),navigator.vibrate&&navigator.vibrate(1e3),t.notice="Ziel erreicht!",t.showNotice=!0,s(function(){r.debug("[places] hide destination notice"),t.showNotice=!1},5e3),t.$emit("slide:change:request")}),t.$on("slide:change:request",function(){r.info("[places] wants to change slide"),t.destinationReached&&t.soundEnded?(t.changeSlide(t.nextSlide?t.nextSlide.id:""),t.resetAutoChange()):r.info(t.destinationReached?"but first lets hear that sound till the end!":"but first we have to get to the destination!")}),t.$on("change:distance",function(e,n){r.debug("[places] changed distance",arguments),s(function(){t.slide.distance=n},500)}),t.trackNextClick=function(){r.info("[tracking] next click"),c.ga("send","event","button","click","next slide")},t.trackPrevClick=function(){r.info("[tracking] prev click"),c.ga("send","event","button","click","prev slide")},t.trackPlayClick=function(){r.info("[tracking] play click"),c.ga("send","event","button","click","play slide")},t.trackPauseClick=function(){r.info("[tracking] pause click"),c.ga("send","event","button","click","pause slide")},t.resetAutoChange=function(){t.destinationReached=!1,t.soundEnded=!1},t.toggleAudio=function(){if(t.slide.audio){var e=g.audios[t.slide.id];r.debug("current audio",e),t.playing(t.slide.id)?(t.trackPauseClick(),e.pause()):(t.trackPlayClick(),e.play())}},t.jumpToEndOfAudio=function(){if(t.slide.audio){var e=g.audios[t.slide.id];e.isPaused()||e.setPercent(98)}},t.watchUserPosition=function(){r.info("[map] watching movements"),n.$on("geolocation:changed",function(e,n){if(t.destinationReached)r.debug("[places] geolocation already reached, cease distance calc");else{{o.slides[t.currentSlide]}if(t.slide.maps&&t.slide.maps.destination&&t.slide.maps.destination.latitude&&t.slide.maps.destination.longitude){r.debug(n.coords.latitude,n.coords.longitude,t.slide.maps.destination.latitude,t.slide.maps.destination.longitude);var i=u.distanceInKm(n.coords.latitude,n.coords.longitude,t.slide.maps.destination.latitude,t.slide.maps.destination.longitude);r.debug("distance",i),t.slide.destination_distance=Math.round(1e3*i*100)/100,t.$emit("change:distance",t.slide.destination_distance),.015>i?(r.debug("reached!",t.currentSlideId,t.nextSlide.id),t.destinationReached=!0,u.unwatch(),t.$emit("map:destination:reached")):r.debug("the waypoint is ",i,"away!")}else r.info("no destination")}}),n.$on("geolocation:error",function(e,n){r.error("Failed watching position",n)}),u.watch()},t.playing=g.playing,t.showNotice=!1,t.currentSlideNumber=t.$index+1,t.totalSlides=Object.keys(o.slides).length,g.pauseAll(),u.unwatch(),t.slide.maps?(t.watchUserPosition(),u.current().then(function(e){r.debug("current position",e),n.$emit("geolocation:changed",e)}).catch(function(e){r.error("Failed to read current Position",e)})):(t.destinationReached=!0,u.unwatch()),t.slide.audio){var h=g.audios[t.slide.id];h.bindOnce("ended",function(){t.soundEnded=!0,t.$emit("slide:change:request")}),h.play()}else t.soundEnded=!0}]),app.controller("MapCtrl",["$rootScope","$scope","$location","$log","leafletData",function(e,n,t,i,a){angular.extend(n,{defaults:{tileLayer:t.protocol()+"://"+t.host()+":"+t.port()+"/tiles/{z}/{x}/{y}.png",maxZoom:18,minZoom:16,tileLayerOptions:{attribution:"Data Â© OpenStreetMap (and) contributors, CC-BY-SA",maxZoom:18,maxNativeZoom:18}},center:{lat:52.5299522,lng:13.4010189,zoom:18},maxbounds:{southWest:{lng:13.3957,lat:52.5252},northEast:{lng:13.4159,lat:52.5315}},events:{map:{enable:["layeradd","drag","click","zoomstart"],logic:"emit"}}}),n.$on("leafletDirectiveMap.layeradd",function(){}),n.$on("leafletDirectiveMap.zoomstart",function(e,n){i.debug("[map] zooming",e,n)}),a.getMap().then(function(e){var t=L.geoJson(null,{style:function(e){return"LineString"===e.geometry.type?(i.debug("[map] styling",e),{color:"#168",opacity:1,dashArray:"10,10"}):{}},pointToLayer:function(e,n){i.debug("marker",n);var t=L.circleMarker(n,{color:"#813",opacity:.8,fillOpacity:.8,fillColor:"#f45",dashArray:null}).setRadius(7);return t.bindLabel(e.properties.name,{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"})}}),a=n.slide.maps.route,o=omnivore.gpx(a,null,t).on("ready",function(){i.info("labelled route"),e.fitBounds(o.getBounds().pad(10))}).addTo(e)}),e.$on("geolocation:changed",function(e,t){a.getMap().then(function(e){n.currentPositionMarker&&e.removeLayer(n.currentPositionMarker);var i=L.latLng(t.coords.latitude,t.coords.longitude);n.currentPositionMarker=L.circleMarker(i,{color:"#318",opacity:.8,fillOpacity:.8,fillColor:"#45f",dashArray:null}).setRadius(7),n.currentPositionMarker.bindLabel("Ich",{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"}).addTo(e)})})}]),app.service("Geolocation",["$rootScope","$window","$q","$log",function(e,n,t,i){function a(e){return e*(Math.PI/180)}var o=this,r=null;this.supportGeolocation=!!n.navigator,this.current=function(){var e=t.defer();return o.supportGeolocation?n.navigator.geolocation.getCurrentPosition(function(n){e.resolve(n)},function(n){e.reject(n)},{enableHighAccuracy:!0}):e.reject({message:"Device does not support Geolocation"}),e.promise},this.watch=function(){o.supportGeolocation?r=n.navigator.geolocation.watchPosition(function(n){e.$emit("geolocation:changed",n)},function(n){e.$emit("geolocation:error",n)},{enableHighAccuracy:!0}):e.$emit("geolocation:error","device does not support geolocation")},this.unwatch=function(){r&&(i.info("[geo] do not care about movements anymore"),n.navigator.geolocation.clearWatch(r))},this.distanceInKm=function(e,n,t,i){var o=6371,r=a(t-e),c=a(i-n),d=Math.sin(r/2)*Math.sin(r/2)+Math.cos(a(e))*Math.cos(a(t))*Math.sin(c/2)*Math.sin(c/2),l=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),s=o*l;return s}}]),app.value("StoryBoard",function(){return[{id:"st-oberholz",caption:"St. Oberholz",audio:"/audio/1.mp3",image:"/images/places/stoberholz.jpg"},{id:"ausland",caption:"Weg zum Haus aus einem anderen Land",maps:{destination:{latitude:52.531189,longitude:13.400258},route:"/maps/a.gpx",image:"/images/routes/1.png"},audio:"/audio/way/a.mp3",autoplay:!0},{id:"haus-aus-einem-anderen-land",caption:"Haus aus einem anderen Land",audio:"/audio/2.mp3",image:"/images/places/haus_aus_einem_anderen_land.jpg"}]}),app.factory("Places",["StoryBoard","$log",function(e){var n=e();return{idToSlideIndex:function(e){var t=n.filter(function(n){return n.id==e});return t[0]?n.indexOf(t[0]):0},indexToSlideId:function(e){var t;return(t=n[e])?t.id:null},slides:n}}]),app.service("Audio",["$q","$log","Places","$rootScope","$timeout",function(e,n,t,i,a){var o=this,r=this.audios={};angular.forEach(t.slides,function(e){e.audio&&(r[e.id]=new buzz.sound(e.audio))}),this.set=function(e,n){r[e]=new buzz.sound(n)},this.play=function(e){var n=r[e];return n?(n.play(),n):!1},this.delayedStartStop=function(e,n){n=n||100;var t=r[e];t.play();var i=function(){t.pause()};return a(i,n,!0)},this.ensureAutoplay=function(){var n=(e.defer(),t.slides.filter(function(e){return!!e.audio}).map(function(e){return o.delayedStartStop(e.id,100)}));return e.all(n)},this.pauseAll=function(){return angular.forEach(r,function(e){e.pause()}),!0},this.playing=function(e){var n=r[e];return n?!n.isPaused():!1}}]),app.service("ApplicationCache",["$log","$window","$rootScope",function(e,n,t){var i=this,a={loaded:0,total:0,ready:!1,percentage:0},o=n.applicationCache;this.isAvailable=function(){return!!o},this.isLoading=function(){if(!this.isAvailable())return!1;switch(o.status){case n.applicationCache.IDLE:case n.applicationCache.UNCACHED:return!1;default:return!0}},this.isCached=function(){return this.isAvailable()?o.status===n.applicationCache.IDLE:!1},this.handleEvent=function(n){switch(e.debug("[cache] event",n,i.progress),n.type){case"checking":t.$emit("cache:loading",a);break;case"downloading":t.$emit("cache:loading",a);break;case"error":i.isCached()?(t.$emit("cache:ready","error"),t.$apply()):location.reload();break;case"noupdate":a.percentage="100%",t.$emit("cache:ready","noupdate"),t.$apply();break;case"progress":a.percentage=n.loaded/n.total*100+"%",a.total=n.total,a.loaded=n.loaded,t.$emit("cache:loading",a),t.$apply();break;case"cached":a.percentage="100%",t.$emit("cache:ready","cached"),t.$apply(),t.$apply();break;case"updateready":a.percentage="100%",t.$emit("cache:ready","updateready"),t.$apply()}},this.init=function(){this.isAvailable()?(e.info("[cache] application cache available"),o.addEventListener("error",this.handleEvent,!1),o.addEventListener("checking",this.handleEvent,!1),o.addEventListener("noupdate",this.handleEvent,!1),o.addEventListener("downloading",this.handleEvent,!1),o.addEventListener("progress",this.handleEvent,!1),o.addEventListener("updateready",this.handleEvent,!1),o.addEventListener("cached",this.handleEvent,!1),this.isLoading()?t.$emit("cache:loading",a):e.info("[cache] not loading on init")):e.info("[cache] no application cache, no love")}}]);