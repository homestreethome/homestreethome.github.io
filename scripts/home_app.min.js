/**
 * audiowalk
 * @version v0.1.0 - 2015-01-22
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
L.CustomPopup=L.Class.extend({includes:L.Mixin.Events,initialize:function(t){this._html=t.content,this._latlng=new L.LatLng(t.lat,t.lon),this._cssClass=t.display_type,_.bindAll(this,"hide")},onAdd:function(t){this._map=t,this._customPopup||this._tmpl(),t.getPanes().popupPane.appendChild(this._customPopup),t.on("viewreset",this._reset,this),this._reset()},hide:function(){$(this._customPopup).hide(),this.hider&&delete this.hider},onRemove:function(t){t.getPanes().popupPane.removeChild(this._customPopup),t.off("viewreset",this._reset,this)},move:function(t){$(this._customPopup).show(),this.hider||(this.hider=_.debounce(this.hide,4e3)),L.DomUtil.setPosition(this._customPopup,t.layerPoint),this.hider()},html:function(t){this._html=t,this._customPopup.innerHTML=t},_tmpl:function(){this._customPopup=L.DomUtil.create("div","leaflet-custom-popup leaflet-custom-popup-"+this._cssClass),this.html(propublica.maps.JST.custom_popup({html:this._html,cssClass:this._cssClass}))},_reset:function(){var t=this._map.latLngToLayerPoint(this._latlng);L.DomUtil.setPosition(this._customPopup,t)},_onImageLoad:function(){this.style.visibility=""}}),$(document).ready(function(){function t(t){return t*(Math.PI/180)}$(document).ready(function(){$(".fancybox").fancybox()});$(".places"),$(".audiowalk-container");$(".navbar-container").affix({offset:{top:function(){return this.top=$(".home-container").outerHeight(!0)}}});var e=function(e,o){var n=e.latitude,i=e.longitude,a=o.latitude,s=o.longitude,l=6371,r=t(a-n),c=t(s-i),u=Math.sin(r/2)*Math.sin(r/2)+Math.cos(t(n))*Math.cos(t(a))*Math.sin(c/2)*Math.sin(c/2),p=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),h=l*p;return h},o=function(){var t=$.Deferred();return $.ajax("maps/home.gpx",{dataType:"xml"}).done(function(e){var o=toGeoJSON.gpx(e);t.resolve(o)}).fail(t.reject),t.promise()};o().done(function(t){console.log("this is home.js calling"),window.viewportUnitsBuggyfill.init();var o=function(){return $(window).width()>1200?14:13},n=o();$(".place").click(function(t){$(".place").removeClass("playing");var e=!$(t.currentTarget).children("audio")[0].paused;console.log("IS",e),$("audio").each(function(){this.pause(),this.currentTime=0}),e?$(t.currentTarget).children("audio")[0].pause():($(t.currentTarget).children("audio")[0].play(),$(t.currentTarget).addClass("playing"),$(t.currentTarget).children("audio")[0].currentTime=0)});var i=L.map("map",{minZoom:13,maxZoom:17,fullscreenControl:!0,zoom:n,scrollWheelZoom:!1}).setView([52.2571198321276,10.5145982516365],n);$(window).resize(function(){13==n&&14==o()&&(i.setView([52.2571198321276,10.5145982516365],o()),i.maxZoom(14))}),i.locate({watch:!0});var a,s=function(t){a&&i.removeLayer(a),a=L.circleMarker(t.latlng,{color:"white",fillColor:"lightGreen",opacity:.9,fillOpacity:.7,className:"bnw-marker"}).setRadius(7),a.bindLabel("Ich",{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"}),a.addTo(i),console.log("luv")},l=function(o){console.log("we are here",o.latlng,"Story",t);var n=t.features.map(function(t){var n=t.geometry.coordinates,i=o.latlng,a=e({longitude:n[0],latitude:n[1]},{longitude:i.lng,latitude:i.lat});return{location:t.properties,distance:a}});n=n.sort(function(t,e){return t.distance>e.distance?-1:t.distance<e.distance?1:0}).reverse(),console.log("distances to you",n)},r=function(t){console.error("failed finding you on the map",t),i.stopLocate()};i.on("locationfound",s),i.on("locationfound",l),i.on("locationerror",r),L.tileLayer("maps/home/tiles/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(i);var c=L.geoJson(null,{style:function(t){return"LineString"===t.geometry.type?(console.log("[map] styling",t),{color:"#168",opacity:1,dashArray:"10,10"}):{}},pointToLayer:function(t,e){console.log("marker",t,e);var o=L.circleMarker(e,{color:"white",opacity:.8,fillOpacity:.8,fillColor:"red",className:"bnw-marker",dashArray:null}).setRadius(7).on("click",function(){console.log(t);var e=$("a[name='"+t.properties.name+"']").parent();e.hasClass("place-large")||e.click();var o=e.parent().parent().offset().top;$("html, body").animate({scrollTop:o},1e3)});return o.bindLabel(t.properties.desc,{noHide:!1,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"})}}),u=function(t,e,o,n){var i=e.lng-t.lng,a=e.lat-t.lat,s=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),l=o*s,r=n*s;return{sw:{lng:t.lng-r,lat:t.lat-l},ne:{lng:e.lng+r,lat:e.lat+l}}},p="maps/home.gpx",h=omnivore.gpx(p,null,c).on("ready",function(){console.log("labelled route");var t=h.getBounds(),e=u(t.getSouthWest(),t.getNorthEast(),.4,1.5),o=L.latLngBounds(L.latLng(e.sw),L.latLng(e.ne));console.log("[map] padded bounds",o),i.setMaxBounds(o)}).addTo(i)})});