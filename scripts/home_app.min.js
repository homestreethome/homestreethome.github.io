/**
 * audiowalk
 * @version v0.1.0 - 2014-11-15
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
L.CustomPopup=L.Class.extend({includes:L.Mixin.Events,initialize:function(t){this._html=t.content,this._latlng=new L.LatLng(t.lat,t.lon),this._cssClass=t.display_type,_.bindAll(this,"hide")},onAdd:function(t){this._map=t,this._customPopup||this._tmpl(),t.getPanes().popupPane.appendChild(this._customPopup),t.on("viewreset",this._reset,this),this._reset()},hide:function(){$(this._customPopup).hide(),this.hider&&delete this.hider},onRemove:function(t){t.getPanes().popupPane.removeChild(this._customPopup),t.off("viewreset",this._reset,this)},move:function(t){$(this._customPopup).show(),this.hider||(this.hider=_.debounce(this.hide,4e3)),L.DomUtil.setPosition(this._customPopup,t.layerPoint),this.hider()},html:function(t){this._html=t,this._customPopup.innerHTML=t},_tmpl:function(){this._customPopup=L.DomUtil.create("div","leaflet-custom-popup leaflet-custom-popup-"+this._cssClass),this.html(propublica.maps.JST.custom_popup({html:this._html,cssClass:this._cssClass}))},_reset:function(){var t=this._map.latLngToLayerPoint(this._latlng);L.DomUtil.setPosition(this._customPopup,t)},_onImageLoad:function(){this.style.visibility=""}}),$(document).ready(function(){function t(t){return t*(Math.PI/180)}var e=$(".places"),o=$(".audiowalk-container"),n=function(){e.masonry({columnWidth:".place-small",itemSelector:".place",stamp:".place-description"})};window.addEventListener("orientationchange",n),$(window).resize(n),$(".navbar-container").affix({offset:{top:function(){return this.top=$(".home-container").outerHeight(!0)}}});var a=function(e,o){var n=e.latitude,a=e.longitude,i=o.latitude,s=o.longitude,l=6371,r=t(i-n),c=t(s-a),u=Math.sin(r/2)*Math.sin(r/2)+Math.cos(t(n))*Math.cos(t(i))*Math.sin(c/2)*Math.sin(c/2),p=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),d=l*p;return d},i=function(){var t=$.Deferred();return e.imagesLoaded(function(){n(),$.ajax("maps/home.gpx",{dataType:"xml"}).done(function(e){var n=toGeoJSON.gpx(e);o.addClass("audiowalk-loaded"),t.resolve(n)}).fail(t.reject)}),t.promise()};i().done(function(t){console.log("this is home.js calling"),window.viewportUnitsBuggyfill.init();var e=function(){return $(window).width()>1200?14:13},o=e();$(".place").click(function(t){$(t.currentTarget).toggleClass("place-small").toggleClass("place-large"),$(t.currentTarget).siblings(".place-large").toggleClass("place-large"),$(t.currentTarget).removeClass("playing"),$(t.currentTarget).siblings(".place").removeClass("playing");var e=!$(t.currentTarget).children("audio")[0].paused;console.log("IS",e),n(),$("audio").each(function(){this.pause(),this.currentTime=0}),e?$(t.currentTarget).children("audio")[0].pause():($(t.currentTarget).children("audio")[0].play(),$(t.currentTarget).addClass("playing"),$(t.currentTarget).children("audio")[0].currentTime=0)});var i=L.map("map",{minZoom:13,maxZoom:17,fullscreenControl:!0,zoom:o,scrollWheelZoom:!1}).setView([52.2571198321276,10.5145982516365],o);$(window).resize(function(){13==o&&14==e()&&(i.setView([52.2571198321276,10.5145982516365],e()),i.maxZoom(14))}),i.locate({watch:!0});var s,l=function(t){s&&i.removeLayer(s),s=L.circleMarker(t.latlng,{color:"white",fillColor:"lightGreen",opacity:.9,fillOpacity:.7,className:"bnw-marker"}).setRadius(7),s.bindLabel("Ich",{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"}),s.addTo(i),console.log("luv")},r=function(e){console.log("we are here",e.latlng,"Story",t);var o=t.features.map(function(t){var o=t.geometry.coordinates,n=e.latlng,i=a({longitude:o[0],latitude:o[1]},{longitude:n.lng,latitude:n.lat});return{location:t.properties,distance:i}});o=o.sort(function(t,e){return t.distance>e.distance?-1:t.distance<e.distance?1:0}).reverse(),console.log("distances to you",o)},c=function(t){console.error("failed finding you on the map",t),i.stopLocate()};i.on("locationfound",l),i.on("locationfound",r),i.on("locationerror",c),L.tileLayer("maps/home/tiles/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(i);var u=L.geoJson(null,{style:function(t){return"LineString"===t.geometry.type?(console.log("[map] styling",t),{color:"#168",opacity:1,dashArray:"10,10"}):{}},pointToLayer:function(t,e){console.log("marker",t,e);var o=L.circleMarker(e,{color:"white",opacity:.8,fillOpacity:.8,fillColor:"red",className:"bnw-marker",dashArray:null}).setRadius(7).on("click",function(){console.log(t);var e=$("a[name='"+t.properties.name+"']").parent();e.hasClass("place-large")||e.click()});return o.bindLabel(t.properties.desc,{noHide:!1,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"})}}),p=function(t,e,o,n){var a=e.lng-t.lng,i=e.lat-t.lat,s=Math.sqrt(Math.pow(a,2)+Math.pow(i,2)),l=o*s,r=n*s;return{sw:{lng:t.lng-r,lat:t.lat-l},ne:{lng:e.lng+r,lat:e.lat+l}}},d="maps/home.gpx",h=omnivore.gpx(d,null,u).on("ready",function(){console.log("labelled route");var t=h.getBounds(),e=p(t.getSouthWest(),t.getNorthEast(),.4,1.5),o=L.latLngBounds(L.latLng(e.sw),L.latLng(e.ne));console.log("[map] padded bounds",o),i.setMaxBounds(o)}).addTo(i)})});